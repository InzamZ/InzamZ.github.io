import{_ as i}from"./ValaxyMain.vue_vue_type_style_index_0_lang-ec0abe3b.js";import{_ as E,u as y,p as d,c as h,w as e,o as b,a as u,b as s,d as l,e as n,r as a,f as F}from"./app-4f30d306.js";import"./YunFooter.vue_vue_type_script_setup_true_lang-03d5cb33.js";import"./YunCard.vue_vue_type_script_setup_true_lang-517fa1c3.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-0705b34e.js";import"./index-463abdac.js";const _="/assets/image-20231117161550751-6bbb4b7e.png",g="/assets/image-20231117161823228-09ff8f33.png",Es=JSON.parse('{"title":"基于 webhook 的 tgbot","description":"","frontmatter":{"title":"基于 webhook 的 tgbot","categories":["ChatBot"],"tags":["serverless","webhook","telegram bot"],"date":"2023-11-17T14:18:56.000Z","updated":"2023-11-17T17:28:39.000Z","draft":false,"hide":false,"end":true},"headers":[{"level":2,"title":"Webhook","slug":"webhook","link":"#webhook","children":[{"level":3,"title":"对比传统 pull 模式","slug":"对比传统-pull-模式","link":"#对比传统-pull-模式","children":[]}]},{"level":2,"title":"Serverless","slug":"serverless","link":"#serverless","children":[{"level":3,"title":"Serverless × Tgbot","slug":"serverless-×-tgbot","link":"#serverless-×-tgbot","children":[]}]},{"level":2,"title":"命令开发","slug":"命令开发","link":"#命令开发","children":[{"level":3,"title":"启用 webhook","slug":"启用-webhook","link":"#启用-webhook","children":[]},{"level":3,"title":"创建云函数","slug":"创建云函数","link":"#创建云函数","children":[]},{"level":3,"title":"编写代码","slug":"编写代码","link":"#编写代码","children":[]}]},{"level":2,"title":"使用 Docker 镜像创建云函数","slug":"使用-docker-镜像创建云函数","link":"#使用-docker-镜像创建云函数","children":[]}],"relativePath":"pages/posts/ChatBot/telegramBotBasedWebhook.md","path":"/home/runner/work/inzamz.github.io/inzamz.github.io/pages/posts/ChatBot/telegramBotBasedWebhook.md","lastUpdated":1700215512000}'),r=JSON.parse('{"title":"基于 webhook 的 tgbot","description":"","frontmatter":{"title":"基于 webhook 的 tgbot","categories":["ChatBot"],"tags":["serverless","webhook","telegram bot"],"date":"2023-11-17T14:18:56.000Z","updated":"2023-11-17T17:28:39.000Z","draft":false,"hide":false,"end":true},"headers":[{"level":2,"title":"Webhook","slug":"webhook","link":"#webhook","children":[{"level":3,"title":"对比传统 pull 模式","slug":"对比传统-pull-模式","link":"#对比传统-pull-模式","children":[]}]},{"level":2,"title":"Serverless","slug":"serverless","link":"#serverless","children":[{"level":3,"title":"Serverless × Tgbot","slug":"serverless-×-tgbot","link":"#serverless-×-tgbot","children":[]}]},{"level":2,"title":"命令开发","slug":"命令开发","link":"#命令开发","children":[{"level":3,"title":"启用 webhook","slug":"启用-webhook","link":"#启用-webhook","children":[]},{"level":3,"title":"创建云函数","slug":"创建云函数","link":"#创建云函数","children":[]},{"level":3,"title":"编写代码","slug":"编写代码","link":"#编写代码","children":[]}]},{"level":2,"title":"使用 Docker 镜像创建云函数","slug":"使用-docker-镜像创建云函数","link":"#使用-docker-镜像创建云函数","children":[]}],"relativePath":"pages/posts/ChatBot/telegramBotBasedWebhook.md","path":"/home/runner/work/inzamz.github.io/inzamz.github.io/pages/posts/ChatBot/telegramBotBasedWebhook.md","lastUpdated":1700215512000}'),m={name:"pages/posts/ChatBot/telegramBotBasedWebhook.md",data(){return{data:r,frontmatter:r.frontmatter,$frontmatter:r.frontmatter}},setup(){const o=y();o.meta.frontmatter=Object.assign(o.meta.frontmatter,r.frontmatter),d("pageData",r)}},k=s("p",null,"在今年早些时候我就有打算使用 webhook 对机器人进行优化，当时也打算使用 serverless 进行优化，但是当时可能由于代码或者环境的问题，延迟无法接受。鉴于毕设打算使用 serverless，打算用这个项目练练手。",-1),v={id:"webhook",tabindex:"-1"},B=s("p",null,"直接翻译就是一个钩子，hook 的概念并不陌生，简单来说，就是在机器人收到消息的时候，服务器会向指定的地址发送一个 POST 请求。我们的程序需要做的就是对这个请求进行处理。",-1),f={id:"对比传统-pull-模式",tabindex:"-1"},C=s("p",null,"传统的 pull 模式是通过部署在服务器上的监控程序，定时向服务器发送请求，查询是否有新的消息。显然这种比较消耗资源。",-1),A={id:"serverless",tabindex:"-1"},D=s("p",null,"Serverless 是最近流行的一种云计算模式，相比起传统的服务器，无服务致力于让开发者专注于开发，而不需要关心服务器的维护。Serverless 的服务器不是我们关心的，我们只需要提供函数，云服务商会按照设定，给函数分配资源。",-1),w={id:"serverless-×-tgbot",tabindex:"-1"},T=s("p",null,"为什么有这种想法呢？当然是因为大陆的特殊性啦，每次部署服务器，你先要部署 clash 内核，然后通过设置代理，才能使机器人正常运行。就算使用 webhook，网络问题也无法避免。",-1),O=s("p",null,"当然可以使用外区的服务器，但是这种服务器价格往往比较高，而且只为了一个机器人不值得，机器负载一直特别低，暴殄天物。而 Serverless 可以自由选择地域，而且价格没有差别。至于费用，现在还没有直观的感受，还在使用新用户的三个月免费额度，如果控制在月租 10 元以内就可以接受。",-1),W=s("p",null,"而且在使用过后我才发现 Serverless 的另一个好处，就是出错后不会影响其他内容。传统的服务端程序，一旦出现错误没有 catch 或者 core 以后，就会直接崩溃，反应为 bot 下线。然后我们就需要重新上线重启程序。而对于每次 webhook 通知都是重启一个示例运行，因此互相不影响。",-1),$={id:"命令开发",tabindex:"-1"},S=s("p",null,[l("云服务商使用的是腾讯云，"),s("s",null,"开启工资回收计划"),l("。但是不得不说腾讯云太容易上手了，示例和文档比较清晰，个人开发者比较好上手。")],-1),P={id:"启用-webhook",tabindex:"-1"},N=s("code",null,"Token",-1),R=s("strong",null,"请妥善保管",-1),x=s("code",null,"api",-1),j=s("div",{class:"language-text"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"text"),s("button",{class:"collapse"}),s("pre",{class:"shiki github-dark vp-code-dark"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#e1e4e8"}},"https://api.telegram.org/bot<token>/METHOD_NAME")])])]),s("pre",{class:"shiki github-light vp-code-light"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#24292e"}},"https://api.telegram.org/bot<token>/METHOD_NAME")])])])],-1),z=s("div",{class:"language-bash"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("button",{class:"collapse"}),s("pre",{class:"shiki github-dark vp-code-dark"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#6A737D"}},"#!/bin/bash")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D"}},"# 替换以下变量为你的Telegram Bot Token 和 Webhook 地址")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"TELEGRAM_BOT_TOKEN"),s("span",{style:{color:"#F97583"}},"="),s("span",{style:{color:"#9ECBFF"}},'"your_bot_token"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"WEBHOOK_URL"),s("span",{style:{color:"#F97583"}},"="),s("span",{style:{color:"#9ECBFF"}},'"your_webhook_url"')]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D"}},"# 设置Telegram Bot Webhook")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B392F0"}},"wget"),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#79B8FF"}},"--method=POST"),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#79B8FF"}},"\\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"     "),s("span",{style:{color:"#79B8FF"}},"--header="),s("span",{style:{color:"#9ECBFF"}},'"Content-Type: application/json"'),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#79B8FF"}},"\\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"     "),s("span",{style:{color:"#79B8FF"}},"--body-data="),s("span",{style:{color:"#9ECBFF"}},'"{'),s("span",{style:{color:"#79B8FF"}},'\\"'),s("span",{style:{color:"#9ECBFF"}},"url"),s("span",{style:{color:"#79B8FF"}},'\\"'),s("span",{style:{color:"#9ECBFF"}},": "),s("span",{style:{color:"#79B8FF"}},'\\"'),s("span",{style:{color:"#E1E4E8"}},"$WEBHOOK_URL"),s("span",{style:{color:"#79B8FF"}},'\\"'),s("span",{style:{color:"#9ECBFF"}},'}"'),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#79B8FF"}},"\\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"     "),s("span",{style:{color:"#9ECBFF"}},'"https://api.telegram.org/bot'),s("span",{style:{color:"#E1E4E8"}},"$TELEGRAM_BOT_TOKEN"),s("span",{style:{color:"#9ECBFF"}},'/setWebhook"')]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D"}},"# 输出执行结果")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#79B8FF"}},"echo"),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#9ECBFF"}},'"Webhook 设置完成。"')])])]),s("pre",{class:"shiki github-light vp-code-light"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#6A737D"}},"#!/bin/bash")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D"}},"# 替换以下变量为你的Telegram Bot Token 和 Webhook 地址")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"TELEGRAM_BOT_TOKEN"),s("span",{style:{color:"#D73A49"}},"="),s("span",{style:{color:"#032F62"}},'"your_bot_token"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"WEBHOOK_URL"),s("span",{style:{color:"#D73A49"}},"="),s("span",{style:{color:"#032F62"}},'"your_webhook_url"')]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D"}},"# 设置Telegram Bot Webhook")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6F42C1"}},"wget"),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#005CC5"}},"--method=POST"),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#005CC5"}},"\\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"     "),s("span",{style:{color:"#005CC5"}},"--header="),s("span",{style:{color:"#032F62"}},'"Content-Type: application/json"'),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#005CC5"}},"\\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"     "),s("span",{style:{color:"#005CC5"}},"--body-data="),s("span",{style:{color:"#032F62"}},'"{'),s("span",{style:{color:"#005CC5"}},'\\"'),s("span",{style:{color:"#032F62"}},"url"),s("span",{style:{color:"#005CC5"}},'\\"'),s("span",{style:{color:"#032F62"}},": "),s("span",{style:{color:"#005CC5"}},'\\"'),s("span",{style:{color:"#24292E"}},"$WEBHOOK_URL"),s("span",{style:{color:"#005CC5"}},'\\"'),s("span",{style:{color:"#032F62"}},'}"'),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#005CC5"}},"\\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"     "),s("span",{style:{color:"#032F62"}},'"https://api.telegram.org/bot'),s("span",{style:{color:"#24292E"}},"$TELEGRAM_BOT_TOKEN"),s("span",{style:{color:"#032F62"}},'/setWebhook"')]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D"}},"# 输出执行结果")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#005CC5"}},"echo"),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#032F62"}},'"Webhook 设置完成。"')])])])],-1),L=s("p",null,"其他参数可以根据需要开启。",-1),M={id:"创建云函数",tabindex:"-1"},K=s("p",null,[l("进入控制台，选择一个非大陆区域，然后新建一个事件函数。"),s("code",null,"web"),l(" 函数要求监听 "),s("code",null,"9000"),l(" 端口，而 "),s("code",null,"tgbot"),l(" 不支持。")],-1),H=s("figure",null,[s("img",{src:_,alt:"创建云函数-1",loading:"lazy",decoding:"async"})],-1),U=s("p",null,"基本设置，下方有个日志配置记得开启，否则会很难调试。",-1),G=s("figure",null,[s("img",{src:g,alt:"创建云函数-2",loading:"lazy",decoding:"async"})],-1),V={id:"编写代码",tabindex:"-1"},Z=s("p",null,"Echo 几乎是每一个 ChatBot 的第一个功能了，但是这是一个最基础的，完成了这个，举一反三就没有其他问题了。",-1),J=s("div",{class:"language-python"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"python"),s("button",{class:"collapse"}),s("pre",{class:"shiki github-dark vp-code-dark"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#F97583"}},"def"),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#B392F0"}},"main_handler"),s("span",{style:{color:"#E1E4E8"}},"(event, context):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"    "),s("span",{style:{color:"#6A737D"}},"# 对 webhook 进行鉴权")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"    "),s("span",{style:{color:"#F97583"}},"if"),s("span",{style:{color:"#E1E4E8"}}," event["),s("span",{style:{color:"#9ECBFF"}},"'headers'"),s("span",{style:{color:"#E1E4E8"}},"]["),s("span",{style:{color:"#9ECBFF"}},"'x-telegram-bot-api-secret-token'"),s("span",{style:{color:"#E1E4E8"}},"] "),s("span",{style:{color:"#F97583"}},"!="),s("span",{style:{color:"#E1E4E8"}}," os.getenv("),s("span",{style:{color:"#9ECBFF"}},"'telegram_bot_api_secret_token'"),s("span",{style:{color:"#E1E4E8"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"        "),s("span",{style:{color:"#F97583"}},"return"),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#9ECBFF"}},'"Api auth failed"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"    "),s("span",{style:{color:"#79B8FF"}},"print"),s("span",{style:{color:"#E1E4E8"}},"("),s("span",{style:{color:"#9ECBFF"}},'"Received event: "'),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#F97583"}},"+"),s("span",{style:{color:"#E1E4E8"}}," json.dumps(event, "),s("span",{style:{color:"#FFAB70"}},"indent"),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#F97583"}},"="),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#79B8FF"}},"2"),s("span",{style:{color:"#E1E4E8"}},"))")])])]),s("pre",{class:"shiki github-light vp-code-light"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#D73A49"}},"def"),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#6F42C1"}},"main_handler"),s("span",{style:{color:"#24292E"}},"(event, context):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"    "),s("span",{style:{color:"#6A737D"}},"# 对 webhook 进行鉴权")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"    "),s("span",{style:{color:"#D73A49"}},"if"),s("span",{style:{color:"#24292E"}}," event["),s("span",{style:{color:"#032F62"}},"'headers'"),s("span",{style:{color:"#24292E"}},"]["),s("span",{style:{color:"#032F62"}},"'x-telegram-bot-api-secret-token'"),s("span",{style:{color:"#24292E"}},"] "),s("span",{style:{color:"#D73A49"}},"!="),s("span",{style:{color:"#24292E"}}," os.getenv("),s("span",{style:{color:"#032F62"}},"'telegram_bot_api_secret_token'"),s("span",{style:{color:"#24292E"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"        "),s("span",{style:{color:"#D73A49"}},"return"),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#032F62"}},'"Api auth failed"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"    "),s("span",{style:{color:"#005CC5"}},"print"),s("span",{style:{color:"#24292E"}},"("),s("span",{style:{color:"#032F62"}},'"Received event: "'),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#D73A49"}},"+"),s("span",{style:{color:"#24292E"}}," json.dumps(event, "),s("span",{style:{color:"#E36209"}},"indent"),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#D73A49"}},"="),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#005CC5"}},"2"),s("span",{style:{color:"#24292E"}},"))")])])])],-1),q=s("p",null,[l("第一部分是对 "),s("code",null,"webhook"),l(" 进行鉴权，"),s("code",null,"main_handler"),l(" 是函数的入口，"),s("code",null,"event"),l(" 包含了请求的消息，"),s("code",null,"context"),l(" 包含了这次运行的示例信息。鉴权是必要的，因为这个接口是暴露在公网的，所以只要获取到函数链接就可以调用。这里防止被其他人使用。（不应该把密码等信息显式编码在代码中）。这里把 "),s("code",null,"event"),l(" 打印出来，对于开发新的命令也有帮助。")],-1),I=s("div",{class:"language-python"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"python"),s("button",{class:"collapse"}),s("pre",{class:"shiki github-dark vp-code-dark"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#6A737D"}},"# def main_handler(event, context):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"		tele_token "),s("span",{style:{color:"#F97583"}},"="),s("span",{style:{color:"#E1E4E8"}}," os.getenv("),s("span",{style:{color:"#9ECBFF"}},'"tele_token"'),s("span",{style:{color:"#E1E4E8"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"    "),s("span",{style:{color:"#F97583"}},"if"),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#F97583"}},"not"),s("span",{style:{color:"#E1E4E8"}}," tele_token:")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"        "),s("span",{style:{color:"#F97583"}},"return"),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#9ECBFF"}},'"No tele_token found"')]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"    bot "),s("span",{style:{color:"#F97583"}},"="),s("span",{style:{color:"#E1E4E8"}}," telebot.TeleBot(tele_token)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"    update "),s("span",{style:{color:"#F97583"}},"="),s("span",{style:{color:"#E1E4E8"}}," json.loads(event["),s("span",{style:{color:"#9ECBFF"}},"'body'"),s("span",{style:{color:"#E1E4E8"}},"].replace("),s("span",{style:{color:"#9ECBFF"}},"'"),s("span",{style:{color:"#79B8FF"}},'\\"'),s("span",{style:{color:"#9ECBFF"}},"'"),s("span",{style:{color:"#E1E4E8"}},", "),s("span",{style:{color:"#9ECBFF"}},`'"'`),s("span",{style:{color:"#E1E4E8"}},"))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"    message "),s("span",{style:{color:"#F97583"}},"="),s("span",{style:{color:"#E1E4E8"}}," update["),s("span",{style:{color:"#9ECBFF"}},"'message'"),s("span",{style:{color:"#E1E4E8"}},"]")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"    "),s("span",{style:{color:"#6A737D"}},"# 命令处理器")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"    "),s("span",{style:{color:"#F97583"}},"if"),s("span",{style:{color:"#E1E4E8"}}," bot "),s("span",{style:{color:"#F97583"}},"and"),s("span",{style:{color:"#E1E4E8"}}," message["),s("span",{style:{color:"#9ECBFF"}},"'entities'"),s("span",{style:{color:"#E1E4E8"}},"]["),s("span",{style:{color:"#79B8FF"}},"0"),s("span",{style:{color:"#E1E4E8"}},"]["),s("span",{style:{color:"#9ECBFF"}},"'type'"),s("span",{style:{color:"#E1E4E8"}},"] "),s("span",{style:{color:"#F97583"}},"=="),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#9ECBFF"}},"'bot_command'"),s("span",{style:{color:"#E1E4E8"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"        bot "),s("span",{style:{color:"#F97583"}},"="),s("span",{style:{color:"#E1E4E8"}}," telebot.TeleBot(tele_token)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"        ret, msg "),s("span",{style:{color:"#F97583"}},"="),s("span",{style:{color:"#E1E4E8"}}," command_handler(message, bot)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"        "),s("span",{style:{color:"#F97583"}},"if"),s("span",{style:{color:"#E1E4E8"}}," ret "),s("span",{style:{color:"#F97583"}},"=="),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#79B8FF"}},"0"),s("span",{style:{color:"#E1E4E8"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"            "),s("span",{style:{color:"#F97583"}},"return"),s("span",{style:{color:"#E1E4E8"}},"(msg)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"        "),s("span",{style:{color:"#79B8FF"}},"print"),s("span",{style:{color:"#E1E4E8"}},"(bot.get_me())")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#E1E4E8"}},"    "),s("span",{style:{color:"#F97583"}},"return"),s("span",{style:{color:"#E1E4E8"}},"("),s("span",{style:{color:"#9ECBFF"}},'"Received message: "'),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#F97583"}},"+"),s("span",{style:{color:"#E1E4E8"}}," json.dumps(message, "),s("span",{style:{color:"#FFAB70"}},"indent"),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#F97583"}},"="),s("span",{style:{color:"#E1E4E8"}}," "),s("span",{style:{color:"#79B8FF"}},"2"),s("span",{style:{color:"#E1E4E8"}},"))")])])]),s("pre",{class:"shiki github-light vp-code-light"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#6A737D"}},"# def main_handler(event, context):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"		tele_token "),s("span",{style:{color:"#D73A49"}},"="),s("span",{style:{color:"#24292E"}}," os.getenv("),s("span",{style:{color:"#032F62"}},'"tele_token"'),s("span",{style:{color:"#24292E"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"    "),s("span",{style:{color:"#D73A49"}},"if"),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#D73A49"}},"not"),s("span",{style:{color:"#24292E"}}," tele_token:")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"        "),s("span",{style:{color:"#D73A49"}},"return"),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#032F62"}},'"No tele_token found"')]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"    bot "),s("span",{style:{color:"#D73A49"}},"="),s("span",{style:{color:"#24292E"}}," telebot.TeleBot(tele_token)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"    update "),s("span",{style:{color:"#D73A49"}},"="),s("span",{style:{color:"#24292E"}}," json.loads(event["),s("span",{style:{color:"#032F62"}},"'body'"),s("span",{style:{color:"#24292E"}},"].replace("),s("span",{style:{color:"#032F62"}},"'"),s("span",{style:{color:"#005CC5"}},'\\"'),s("span",{style:{color:"#032F62"}},"'"),s("span",{style:{color:"#24292E"}},", "),s("span",{style:{color:"#032F62"}},`'"'`),s("span",{style:{color:"#24292E"}},"))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"    message "),s("span",{style:{color:"#D73A49"}},"="),s("span",{style:{color:"#24292E"}}," update["),s("span",{style:{color:"#032F62"}},"'message'"),s("span",{style:{color:"#24292E"}},"]")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"    "),s("span",{style:{color:"#6A737D"}},"# 命令处理器")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"    "),s("span",{style:{color:"#D73A49"}},"if"),s("span",{style:{color:"#24292E"}}," bot "),s("span",{style:{color:"#D73A49"}},"and"),s("span",{style:{color:"#24292E"}}," message["),s("span",{style:{color:"#032F62"}},"'entities'"),s("span",{style:{color:"#24292E"}},"]["),s("span",{style:{color:"#005CC5"}},"0"),s("span",{style:{color:"#24292E"}},"]["),s("span",{style:{color:"#032F62"}},"'type'"),s("span",{style:{color:"#24292E"}},"] "),s("span",{style:{color:"#D73A49"}},"=="),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#032F62"}},"'bot_command'"),s("span",{style:{color:"#24292E"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"        bot "),s("span",{style:{color:"#D73A49"}},"="),s("span",{style:{color:"#24292E"}}," telebot.TeleBot(tele_token)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"        ret, msg "),s("span",{style:{color:"#D73A49"}},"="),s("span",{style:{color:"#24292E"}}," command_handler(message, bot)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"        "),s("span",{style:{color:"#D73A49"}},"if"),s("span",{style:{color:"#24292E"}}," ret "),s("span",{style:{color:"#D73A49"}},"=="),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#005CC5"}},"0"),s("span",{style:{color:"#24292E"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"            "),s("span",{style:{color:"#D73A49"}},"return"),s("span",{style:{color:"#24292E"}},"(msg)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"        "),s("span",{style:{color:"#005CC5"}},"print"),s("span",{style:{color:"#24292E"}},"(bot.get_me())")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E"}},"    "),s("span",{style:{color:"#D73A49"}},"return"),s("span",{style:{color:"#24292E"}},"("),s("span",{style:{color:"#032F62"}},'"Received message: "'),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#D73A49"}},"+"),s("span",{style:{color:"#24292E"}}," json.dumps(message, "),s("span",{style:{color:"#E36209"}},"indent"),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#D73A49"}},"="),s("span",{style:{color:"#24292E"}}," "),s("span",{style:{color:"#005CC5"}},"2"),s("span",{style:{color:"#24292E"}},"))")])])])],-1),Q=s("p",null,[l("后面就是常规的处理了，注意的是 "),s("code",null,"json"),l(" 格式中的所以双引号都被转义了，需要替换回来。")],-1),X={id:"使用-docker-镜像创建云函数",tabindex:"-1"},Y=s("p",null,"这个的应用场景是我的毕设需要使用的，在线评测系统需要使用 docker 隔离评测环境，因此我们需要使用构建一个镜像用于启动。最近应该会完善和上传，感谢您的阅读。",-1);function ss(o,ls,es,os,c,ts){const t=F,p=i;return b(),h(p,{frontmatter:c.frontmatter,data:c.data},{"main-content-md":e(()=>[k,u(" more "),s("h2",v,[l("Webhook "),n(t,{class:"header-anchor",href:"#webhook","aria-label":'Permalink to "Webhook"'},{default:e(()=>[l("​")]),_:1})]),B,s("h3",f,[l("对比传统 pull 模式 "),n(t,{class:"header-anchor",href:"#对比传统-pull-模式","aria-label":'Permalink to "对比传统 pull 模式"'},{default:e(()=>[l("​")]),_:1})]),C,s("h2",A,[l("Serverless "),n(t,{class:"header-anchor",href:"#serverless","aria-label":'Permalink to "Serverless"'},{default:e(()=>[l("​")]),_:1})]),D,s("h3",w,[l("Serverless × Tgbot "),n(t,{class:"header-anchor",href:"#serverless-×-tgbot","aria-label":'Permalink to "Serverless × Tgbot"'},{default:e(()=>[l("​")]),_:1})]),T,O,W,s("h2",$,[l("命令开发 "),n(t,{class:"header-anchor",href:"#命令开发","aria-label":'Permalink to "命令开发"'},{default:e(()=>[l("​")]),_:1})]),S,s("h3",P,[l("启用 webhook "),n(t,{class:"header-anchor",href:"#启用-webhook","aria-label":'Permalink to "启用 webhook"'},{default:e(()=>[l("​")]),_:1})]),s("p",null,[l("首先你需要有一个机器人，这个向 "),n(t,{href:"https://t.me/BotFather",target:"_blank",rel:"noreferrer"},{default:e(()=>[l("@BotFather")]),_:1}),l(" 申请就可以。按照指引进行申请，成功后你会得到一个 "),N,l("，这个相当于机器人的密码，拥有就可以控制机器人，"),R,l("。")]),s("p",null,[l("然后我们通过调用 api 来开启 webhook。参考"),n(t,{href:"https://core.telegram.org/bots/api",target:"_blank",rel:"noreferrer"},{default:e(()=>[l("官方文档")]),_:1}),l("，所有 "),x,l(" 都是按照如下方式鉴权调用的。")]),j,s("p",null,[l("我们可以看到 "),n(t,{href:"https://core.telegram.org/bots/api#setwebhook",target:"_blank",rel:"noreferrer"},{default:e(()=>[l("setwebhook")]),_:1}),l(" 接口，通过调用这个接口启用 webhook。你可以直接询问 ChatGPT，这样事半功倍。")]),z,L,s("h3",M,[l("创建云函数 "),n(t,{class:"header-anchor",href:"#创建云函数","aria-label":'Permalink to "创建云函数"'},{default:e(()=>[l("​")]),_:1})]),K,H,U,G,s("h3",V,[l("编写代码 "),n(t,{class:"header-anchor",href:"#编写代码","aria-label":'Permalink to "编写代码"'},{default:e(()=>[l("​")]),_:1})]),Z,J,q,I,Q,s("h2",X,[l("使用 Docker 镜像创建云函数 "),n(t,{class:"header-anchor",href:"#使用-docker-镜像创建云函数","aria-label":'Permalink to "使用 Docker 镜像创建云函数"'},{default:e(()=>[l("​")]),_:1})]),Y]),"main-header":e(()=>[a(o.$slots,"main-header")]),"main-header-after":e(()=>[a(o.$slots,"main-header-after")]),"main-nav":e(()=>[a(o.$slots,"main-nav")]),"main-content":e(()=>[a(o.$slots,"main-content")]),"main-content-after":e(()=>[a(o.$slots,"main-content-after")]),"main-nav-before":e(()=>[a(o.$slots,"main-nav-before")]),"main-nav-after":e(()=>[a(o.$slots,"main-nav-after")]),comment:e(()=>[a(o.$slots,"comment")]),footer:e(()=>[a(o.$slots,"footer")]),aside:e(()=>[a(o.$slots,"aside")]),"aside-custom":e(()=>[a(o.$slots,"aside-custom")]),default:e(()=>[a(o.$slots,"default")]),_:3},8,["frontmatter","data"])}const ys=E(m,[["render",ss]]);export{Es as __pageData,ys as default};
